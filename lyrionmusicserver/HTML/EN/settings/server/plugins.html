[% descHeight = 650 %]
[% iconSize = 50 %]
[% pageHeaderScripts = BLOCK %]
	<script TYPE="text/javascript" src="[% webroot %]html/common.js?r=[% revision %]"></script>
[% END %]
[% PROCESS settings/server/plugins_main.html %]
<script>
	var searchData = [% searchData %];

	var filterChooser = $('filterChooser').down();
	var filterInput = $('filterInput');
	var viewToggle = $('viewToggle');

	filterChooser.observe('change', function(event) {
		filterInput.value = '';

		var mostPopular = new Set(Object.keys(searchData).sort(function(a, b) {
			return (searchData[b].installs || -1) - (searchData[a].installs || -1)
		}).slice(0, 15));

		var id = event.target.value;
		togglePluginVisibility(id, id === 'top'
			? function(s, id) {
				return mostPopular.has(id);
			}
			: function(s) {
				return s.category == id;
			}
		);
	});

	filterInput.observe('keyup', function(event) {
		filterChooser.value = '';

		var value = event.target.value;
		var reg = new RegExp(value, 'i');
		togglePluginVisibility(value, function(s) {
			return reg.test(s.content);
		});
	});

	viewToggle.on('click', function() {
		var view = viewToggle.src.match(/grid|list/)[0];
		var newView = view === 'grid' ? 'list' : 'grid';
		viewToggle.src = viewToggle.src.replace(view+'.svg', newView+'.svg');
		setCookie('Squeezebox-viewMode', view);

		if (newView === 'grid') {
			$('pluginListPanel').addClassName('pluginListList');
		}
		else {
			$('pluginListPanel').removeClassName('pluginListList');
		}
	});

	function togglePluginVisibility(value, validator) {
		var pluginListPanel = $$('li.thumbwrap');

		if (!value) {
			pluginListPanel.forEach(function(item) {
				item.show();
			});
		}
		else {
			pluginListPanel.forEach(function(item) {
				var id = item.id.replace('plugin-', '');

				let s = searchData[id];

				if (s && validator(s, id)) {
					item.show();
				}
				else {
					item.hide();
				}
			});
		}
	}
</script>
